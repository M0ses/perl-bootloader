#! /usr/bin/perl -w

use POSIX;
use Getopt::Long;
use vars qw($opt_add $opt_remove $opt_image $opt_initrd $opt_name $opt_default $opt_previous);
use Bootloader::Tools;
use Locale::gettext;
use strict;

sub synopsis()
{
    print STDERR "SYNOPSIS: $0 {--image file} [--initrd file] " .
		 "[--default] [--previous] {--add|--remove}\n";
    exit 1
}

$opt_default = 0;
$opt_previous = 0;

setlocale(LC_MESSAGES, Bootloader::Tools::GetSystemLanguage());

my $d =  Locale::gettext->domain("bootloader");
$d->dir("/usr/share/YaST2/locale");

GetOptions (
	'add' => \$opt_add,
	'remove' => \$opt_remove,
	'image=s' => \$opt_image,
	'initrd=s' => \$opt_initrd,
	'name=s' => \$opt_name,
	'default' => \$opt_default,
	'previous' => \$opt_previous)
    or synopsis;

synopsis unless ($opt_image or $opt_previous or $opt_add or $opt_remove);

if ($opt_image)
{
    $opt_image = getcwd . '/' . $opt_image
    if ($opt_image !~ m#^/#);
}

if ($opt_initrd)
{
    $opt_initrd = getcwd . '/' . $opt_initrd
    if ($opt_initrd !~ m#^/#);
}

InitLibrary();

my $loader = Bootloader::Tools::GetBootloader();

if ($opt_previous)
{
    $opt_image = Bootloader::Tools::GetDefaultImage() . ".previous";
    $opt_initrd = Bootloader::Tools::GetDefaultInitrd() . ".previous";
}

if ($opt_add)
{
    if ($opt_previous)
    {
        $opt_name = "Previous Kernel";

        # only localize on grub and lilo
    	if ($loader eq "grub" || $loader eq "lilo")
    	{
    	    $opt_name = $d->get($opt_name);
            chomp ($opt_name);
	    
            # check wether translation only contains [a-zA-Z0-9 _]
            # otherwise don't translate
            if ($opt_name !~ /^[a-zA-Z0-9 _]+$/g )
            {
                $opt_name = "Previous Kernel";
            }

            if($loader ne "grub")
            {
                #only grub allows blanks in section titles
                $opt_name =~ s/ /_/g;
                #restrict lenght to 16 chars
                $opt_name = substr ($opt_name, 0, 15);
            }
        }
        # add product name and version
        $opt_name .= `yast2 /usr/share/YaST2/modules/print-product.ycp 2>&1`;
        chomp $opt_name;
    }
    else
    {
    	unless ($opt_name)
    	{
            $opt_name = $opt_image;
    	}
    }

    unless (CountImageSections($opt_image))
    {
        AddNewImageSection($opt_name, $opt_image, $opt_initrd, $opt_default);
    }

}
elsif ($opt_remove)
{
    if (CountImageSections($opt_image))
    {
        RemoveImageSections($opt_image);
    }
}
